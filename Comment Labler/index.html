<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Comment Labeler</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .label-button.highlight {
            animation: glow 1.5s infinite alternate;
        }
        @keyframes glow {
            from {
                box-shadow: 0 0 2px #2563eb, 0 0 4px #2563eb, 0 0 6px #2563eb;
            }
            to {
                box-shadow: 0 0 6px #2563eb, 0 0 10px #2563eb, 0 0 14px #2563eb;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex items-center justify-center min-h-screen">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Community Labeler</h1>
            <div id="auth-container">
                <!-- Auth buttons will be injected here by JS -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="bg-white p-6 md:p-8 rounded-lg shadow-md min-h-[500px] flex flex-col justify-between hidden">
            
            <!-- Comment Loading/Error/Done State -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <span id="comment-count" class="text-sm font-medium text-gray-500">Loading...</span>
                    <button id="suggest-label-button" class="text-sm text-blue-600 font-medium hover:text-blue-800 transition-colors">
                        Suggest Label ✨
                    </button>
                </div>
                
                <!-- AI Suggestion Box -->
                <div id="ai-suggestion-box" class="hidden bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-md mb-4 text-center text-sm">
                    <strong class_mode="font-semibold">AI Suggestion:</strong> <span id="ai-suggestion-text"></span>
                </div>

                <div id="comment-container" class="relative min-h-[200px] flex items-center justify-center">
                    <!-- Loading Spinner -->
                    <div id="loader" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                        <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    
                    <!-- Comment Text -->
                    <p id="comment-text" class="text-lg md:text-xl leading-relaxed text-gray-800 text-center"></p>
                    
                    <!-- All Done Message -->
                    <div id="all-done-message" class="hidden text-center">
                        <h2 class="text-2xl font-semibold text-green-600 mb-2">All Done!</h2>
                        <p class="text-gray-600">Thank you for your help. You're a labeling hero!</p>
                        <p class="text-gray-600 mt-1">Check the leaderboard to see your final rank.</p>
                    </div>
                </div>
            </div>

            <!-- Labeling Buttons -->
            <div id="label-buttons-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 pt-6 border-t border-gray-200">
                <button data-label="hope" class="label-button bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform active:scale-95">Hope</button>
                <button data-label="determination" class="label-button bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform active:scale-95">Determination</button>
                <button data-label="fear" class="label-button bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform active:scale-95">Fear</button>
                <button data-label="neutral" class="label-button bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform active:scale-95">Neutral</button>
            </div>
        </main>

        <!-- Leaderboard -->
        <aside id="leaderboard" class="bg-white p-6 md:p-8 rounded-lg shadow-md mt-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Leaderboard</h2>
            <div class="space-y-3" id="leaderboard-list">
                <!-- Leaderboard items will be injected here by JS -->
                <p class="text-gray-500">Loading rankings...</p>
            </div>
        </aside>

        <!-- Login Screen -->
        <div id="login-screen" class="text-center bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4">Welcome to the Labeler!</h2>
            <p class="text-gray-600 mb-6">Help us improve our dataset by labeling comments. Please sign in to participate.</p>
            <button id="login-button" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                Sign In with Google
            </button>
        </div>

        <!-- Error Modal -->
        <div id="error-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-lg font-medium text-red-600 mb-2">Connection Error</h3>
                <p id="error-message" class="text-gray-700 mb-4">Could not connect to Firebase. Please check console.</p>
                <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">
                    Close
                </button>
            </div>
        </div>

    </div> <!-- End Main Container -->

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** FIX: Corrected the typo in the firestore URL ***
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, getDocs, increment, runTransaction, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- START OF FIX: This function works in all browsers ---
        /**
         * Generates a simple, non-secure UUID.
         * This is a fallback for Safari on non-secure (http://) contexts.
         */
        function generateUUID() {
            let d = new Date().getTime();
            let d2 = (performance && performance.now && (performance.now() * 1000)) || 0;
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                let r = Math.random() * 16;
                if (d > 0) {
                    r = (d + r) % 16 | 0;
                    d = Math.floor(d / 16);
                } else {
                    r = (d2 + r) % 16 | 0;
                    d2 = Math.floor(d2 / 16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
        // --- END OF FIX ---

        // Firebase Configuration
        // IMPORTANT: PASTE YOUR FIREBASE CONFIG OBJECT HERE
        const firebaseConfig = {
          apiKey: "AIzaSyA5KPV29CVnoFPd5grozTmYQrupHXf613A",
          authDomain: "comment-labeler-project.firebaseapp.com",
          projectId: "comment-labeler-project",
          storageBucket: "comment-labeler-project.firebasestorage.app",
          messagingSenderId: "642718397182",
          appId: "1:642718397182:web:ea5953b9eb367c7efb2baf",
          measurementId: "G-823CKFMJHX"
        };
        
        // App-specific ID (must match upload.js and database)
        const appId = 'default-labeler-app';

        // State variables
        let app, auth, db, provider;
        let currentUser = null;
        let userId = null;
        let authReady = false;
        let currentComment = null;

        // UI Elements
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const mainContent = document.getElementById('main-content');
        const leaderboardEl = document.getElementById('leaderboard');
        const authContainer = document.getElementById('auth-container');
        const loader = document.getElementById('loader');
        const commentTextEl = document.getElementById('comment-text');
        const commentCountEl = document.getElementById('comment-count');
        const allDoneMessage = document.getElementById('all-done-message');
        const labelButtonsContainer = document.getElementById('label-buttons-container');
        const leaderboardList = document.getElementById('leaderboard-list');
        const errorModal = document.getElementById('error-modal');
        const errorMessageEl = document.getElementById('error-message');
        const suggestLabelButton = document.getElementById('suggest-label-button');
        const aiSuggestionBox = document.getElementById('ai-suggestion-box');
        const aiSuggestionText = document.getElementById('ai-suggestion-text');

        /**
         * Initialize Firebase
         */
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                provider = new GoogleAuthProvider();
                setLogLevel('Debug'); // Enable debug logging for Firestore
                setupAuthListener();
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showError("Firebase initialization failed. Please check your `firebaseConfig` details in the HTML file.");
            }
        }

        /**
         * Show a friendly error modal
         */
        function showError(message) {
            errorMessageEl.textContent = message;
            errorModal.classList.remove('hidden');
        }

        /**
         * Listen for authentication state changes
         */
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    userId = user.uid;
                    authReady = true;
                    showAppUI(user);
                    fetchNextComment();
                    setupLeaderboardListener();
                } else {
                    // User is signed out
                    currentUser = null;
                    // --- START OF FIX: Use generateUUID() as fallback ---
                    userId = generateUUID(); 
                    // --- END OF FIX ---
                    authReady = true; // Still ready, but as an anonymous user
                    showLoginUI();
                }
            });
        }

        /**
         * Show the main application UI for logged-in users
         */
        function showAppUI(user) {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            leaderboardEl.classList.remove('hidden');

            authContainer.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600 hidden md:block">${user.email}</span>
                    <button id="logout-button" class="text-sm font-medium text-blue-600 hover:text-blue-800">Sign Out</button>
                </div>
            `;
            document.getElementById('logout-button').addEventListener('click', handleSignOut);
        }

        /**
         * Show the login UI for signed-out users
         */
        function showLoginUI() {
            loginScreen.classList.remove('hidden');
            mainContent.classList.add('hidden');
            leaderboardEl.classList.add('hidden');
            authContainer.innerHTML = ''; // Clear auth container
        }

        /**
         * Handle Google Sign-In
         */
        async function handleSignIn() {
            try {
                await signInWithPopup(auth, provider);
                // Auth listener will handle the UI change
            } catch (e) {
                console.error("Sign-in error:", e);
                if (e.code === 'auth/popup-blocked-by-browser') {
                    showError("Sign-in popup was blocked by the browser. Please allow popups for this site.");
                } else if (e.code === 'auth/cancelled-popup-request') {
                    // User closed the popup, no error needed.
                } else {
                    showError("Could not sign in. Please check the console for details.");
                }
            }
        }

        /**
         * Handle Sign-Out
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                // Auth listener will handle the UI change
            } catch (e) {
                console.error("Sign-out error:", e);
                showError("Error signing out.");
            }
        }

        /**
         * Set the loading state of the comment section
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                commentTextEl.textContent = '';
                allDoneMessage.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        /**
         * Fetch the next unlabeled comment from Firestore
         */
        async function fetchNextComment() {
            if (!authReady) {
                console.log("Auth not ready, skipping fetch.");
                return; 
            }

            console.log("Setting loading state to TRUE.");
            setLoadingState(true);
            currentComment = null;
            clearSuggestionHighlights();

            try {
                // Get total count
                console.log("Querying for total comment count...");
                const countQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'comments'));
                const countSnapshot = await getDocs(countQuery);
                const totalComments = countSnapshot.size;
                console.log("Total comments found:", totalComments);

                // Get completed count
                console.log("Querying for completed comment count...");
                const completedQuery = query(countQuery, where('isLabeled', '==', true));
                const completedSnapshot = await getDocs(completedQuery);
                const completedComments = completedSnapshot.size;
                console.log("Completed comments found:", completedComments);

                commentCountEl.textContent = `${completedComments} / ${totalComments} Labeled`;

                // Get next comment
                console.log("Querying for next unlabeled comment...");
                const commentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'comments');
                // *** SIMPLIFIED QUERY: Removed 'orderBy' to avoid needing an index ***
                const q = query(commentsRef, where('isLabeled', '==', false), limit(1));
                const querySnapshot = await getDocs(q);
                console.log("Unlabeled comment query finished.");

                if (querySnapshot.empty) {
                    // All comments are labeled
                    console.log("No unlabeled comments found.");
                    setLoadingState(false);
                    allDoneMessage.classList.remove('hidden');
                    commentTextEl.classList.add('hidden');
                    labelButtonsContainer.classList.add('hidden');
                    suggestLabelButton.classList.add('hidden');
                    clearSuggestionHighlights();
                } else {
                    const doc = querySnapshot.docs[0];
                    currentComment = { id: doc.id, ...doc.data() };
                    console.log("Found comment:", doc.id);
                    commentTextEl.textContent = currentComment.text;
                    setLoadingState(false);
                    console.log("Setting loading state to FALSE.");
                }
            } catch (e) {
                console.error("Error fetching comment: ", e);
                // *** NEW ERROR CHECK: Check for Firestore index error ***
                if (e.code === 'failed-precondition') {
                     showError("Firestore Error: This query requires an index. Please open the developer console (Option+Cmd+J), find the error message with a link, open the link in a new tab, and click 'Create Index'.");
                } else {
                    showError("Error loading comment. Please refresh and check console.");
                }
                commentTextEl.textContent = "Error loading comment. Please check console.";
                setLoadingState(false);
                console.log("Setting loading state to FALSE due to error.");
            }
        }

        /**
         * Handle a label button click
         */
        async function handleLabelClick(e) {
            if (!currentComment || !currentUser) return;

            const label = e.target.dataset.label;
            const commentId = currentComment.id;
            const userEmail = currentUser.email;

            // Optimistically update UI
            setLoadingState(true);

            try {
                // 1. Update the comment
                const commentRef = doc(db, 'artifacts', appId, 'public', 'data', 'comments', commentId);
                await updateDoc(commentRef, {
                    label: label,
                    isLabeled: true,
                    labeledBy: userId,
                    labeledByEmail: userEmail
                });

                // 2. Update the user's score in the leaderboard (using a transaction)
                const leaderboardRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', userId);
                
                await runTransaction(db, async (transaction) => {
                    const leaderboardDoc = await transaction.get(leaderboardRef);
                    if (!leaderboardDoc.exists()) {
                        transaction.set(leaderboardRef, {
                            email: userEmail,
                            count: 1
                        });
                    } else {
                        const newCount = (leaderboardDoc.data().count || 0) + 1;
                        transaction.update(leaderboardRef, { 
                            count: newCount,
                            email: userEmail // Ensure email is up-to-date
                        });
                    }
                });

                // 3. Fetch the next comment
                fetchNextComment();

            } catch (e) {
                console.error("Error submitting label: ", e);
                showError("Could not submit label. Please try again.");
                setLoadingState(false); // Revert loading state on error
            }
        }

        /**
         * Set up a real-time listener for the leaderboard
         */
        function setupLeaderboardListener() {
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            // We sort by 'count' descending to get the top users.
            // This will require a Firestore index.
            const q = query(leaderboardRef, orderBy("count", "desc"), limit(10));
            
            onSnapshot(q, (querySnapshot) => {
                const users = [];
                querySnapshot.forEach((doc) => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                // Update leaderboard UI
                leaderboardList.innerHTML = ''; // Clear existing list
                if (users.length === 0) {
                    leaderboardList.innerHTML = '<p class="text-gray-500">No one has labeled any comments yet.</p>';
                    return;
                }

                users.forEach((user, index) => {
                    const rank = index + 1;
                    const isCurrentUser = user.id === userId;
                    const userEmail = user.email ? user.email.split('@')[0] : 'Anonymous';

                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-3 rounded-lg ${isCurrentUser ? 'bg-blue-50' : ''}`;
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="font-bold w-6 text-gray-700">${rank}.</span>
                            <span class="font-medium ${isCurrentUser ? 'text-blue-700' : 'text-gray-800'}">${userEmail}</span>
                        </div>
                        <span class="font-bold text-gray-800">${user.count || 0}</span>
                    `;
                    leaderboardList.appendChild(item);
                });
            }, (error) => {
                console.error("Error listening to leaderboard: ", error);
                // *** NEW ERROR CHECK: Check for Firestore index error ***
                if (error.code === 'failed-precondition') {
                    leaderboardList.innerHTML = '<p class="text-red-500">Error: Leaderboard needs an index. Please open the console (Option+Cmd+J) and click the link to create it.</p>';
                     showError("Firestore Error: The Leaderboard query requires an index. Please open the developer console (Option+Cmd+J), find the error message with a link, open the link in a new tab, and click 'Create Index'.");
                } else {
                    leaderboardList.innerHTML = '<p class="text-red-500">Error loading leaderboard.</p>';
                }
            });
        }

        // --- Gemini API Functions ---

        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const API_KEY = ""; // Kept as "" per instructions
        const SYSTEM_PROMPT = `You are an expert text classifier. Analyze the following user comment and classify it into one of four categories:
- hope: Expresses optimism, positive expectations, or a wish for a good outcome.
- determination: Expresses a strong will, resolve, or a plan to overcome obstacles.
- fear: Expresses anxiety, worry, pessimism, or concern about a negative outcome.
- neutral: Makes an objective statement, observation, or is off-topic.

Respond with ONLY the category name (hope, determination, fear, or neutral) and nothing else.`;


        /**
         * Calls the Gemini API with exponential backoff
         */
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            try {
                const response = await fetch(`${API_URL}${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        // Throttled, retry with backoff
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiAPI(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    return text.trim().toLowerCase();
                } else {
                    throw new Error("Invalid API response structure.");
                }

            } catch (e) {
                if (retries > 0) {
                    // Network or other error, retry with backoff
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                console.error("Error calling Gemini API:", e);
                throw e; // Final failure
            }
        }

        /**
         * Handle "Suggest Label" button click
         */
        async function handleSuggestLabel() {
            if (!currentComment) return;

            suggestLabelButton.disabled = true;
            suggestLabelButton.textContent = "Thinking...";
            aiSuggestionBox.classList.add('hidden');
            clearSuggestionHighlights();

            try {
                const suggestion = await callGeminiAPI(currentComment.text);
                
                aiSuggestionText.textContent = suggestion.charAt(0).toUpperCase() + suggestion.slice(1);
                aiSuggestionBox.classList.remove('hidden');
                
                // Highlight the suggested button
                const button = document.querySelector(`.label-button[data-label="${suggestion}"]`);
                if (button) {
                    button.classList.add('highlight');
                }

            } catch (e) {
                aiSuggestionText.textContent = "Could not get suggestion.";
                aiSuggestionBox.classList.remove('hidden');
                console.error("Error getting suggestion:", e);
            } finally {
                suggestLabelButton.disabled = false;
                suggestLabelButton.textContent = "Suggest Label ✨";
            }
        }

        /**
         * Clear all highlights from label buttons
         */
        function clearSuggestionHighlights() {
            aiSuggestionBox.classList.add('hidden');
            document.querySelectorAll('.label-button').forEach(btn => {
                btn.classList.remove('highlight');
            });
        }


        // --- Event Listeners ---
        loginButton.addEventListener('click', handleSignIn);
        suggestLabelButton.addEventListener('click', handleSuggestLabel);
        labelButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('label-button')) {
                handleLabelClick(e);
            }
        });

        // --- Initial Load ---
        initializeFirebase();

    </script>
</body>
</html>